{"data":[{"updatedAt":"2026-01-14T20:39:31.856Z","createdAt":"2026-01-14T20:12:42.971Z","id":"0YKJNIVfawJSNlivpDCbE","name":"Leer Precios","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-128,0],"id":"52e92a41-55bb-43d8-b4ac-b674c85e47f5","name":"When clicking â€˜Execute workflowâ€™"},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?gid=1261057698#gid=1261057698","mode":"url"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Productos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[144,0],"id":"49bde97b-409b-48db-a5f9-f7a0221bba74","name":"Get row(s) in sheet","credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}}],"connections":{"When clicking â€˜Execute workflowâ€™":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"00d1ef10-1b69-4176-8bce-d3bb6059a90d","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-14T20:12:42.976Z","createdAt":"2026-01-14T20:12:42.976Z","role":"workflow:owner","workflowId":"0YKJNIVfawJSNlivpDCbE","projectId":"6XQHFhZ2nguxJcVZ"}],"activeVersion":null,"tags":[]},{"updatedAt":"2026-01-14T21:49:28.934Z","createdAt":"2026-01-14T20:40:01.869Z","id":"2vLGSqqpdnTSew4xJKZEY","name":"Actualizar DB","active":false,"isArchived":false,"nodes":[{"parameters":{"authentication":"serviceAccount","operation":"appendOrUpdate","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?gid=1261057698#gid=1261057698","mode":"url"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Productos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Id":"={{ $json.id }}","nombre_producto":"={{ $json.nombre_producto }}","categoria":"={{ $json.categoria }}","precio":"={{ $json.precio }}","descripcion":"={{ $json.descripcion }}","palabras_clave":"={{ $json.palabras_clave }}"},"matchingColumns":["Id"],"schema":[{"id":"Id","displayName":"Id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"nombre_producto","displayName":"nombre_producto","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"categoria","displayName":"categoria","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"precio","displayName":"precio","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"descripcion","displayName":"descripcion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"palabras_clave","displayName":"palabras_clave","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[320,-48],"id":"ac1934a7-1cff-4f8c-b4f7-8b3f470a01bb","name":"Append or update row in sheet","credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"httpMethod":"POST","path":"ACTUALIZAR","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-208,-48],"id":"10e7551c-9a27-4b64-a330-37b22606f49c","name":"Webhook","webhookId":"3f71ae05-c4c5-4831-9e50-77cb7413f025"},{"parameters":{"fieldToSplitOut":"body.productos","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[64,-48],"id":"88e7abcb-80a3-49e6-8265-304e35bb9ae4","name":"Split Out"}],"connections":{"Webhook":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"Append or update row in sheet","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"d68c5a9c-40b5-4463-a6fd-295252f2dfe3","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-14T20:40:01.884Z","createdAt":"2026-01-14T20:40:01.884Z","role":"workflow:owner","workflowId":"2vLGSqqpdnTSew4xJKZEY","projectId":"6XQHFhZ2nguxJcVZ"}],"activeVersion":null,"tags":[]},{"updatedAt":"2026-01-20T05:40:05.563Z","createdAt":"2026-01-20T05:40:05.563Z","id":"AOcXtXXJ-wlTSkZsCx9gb","name":"My workflow","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.3,"position":[0,0],"id":"9dd34017-71da-45b9-9958-15b698fcd085","name":"Schedule Trigger"},{"parameters":{"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[464,64],"id":"8ee697e9-6f9f-476e-90c1-d8dc78373ad2","name":"HTTP Request"}],"connections":{},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"cfad81d3-b403-43d4-ad0d-96d10a57b12b","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-20T05:40:05.582Z","createdAt":"2026-01-20T05:40:05.582Z","role":"workflow:owner","workflowId":"AOcXtXXJ-wlTSkZsCx9gb","projectId":"6XQHFhZ2nguxJcVZ"}],"activeVersion":null,"tags":[]},{"updatedAt":"2026-01-20T05:07:02.933Z","createdAt":"2026-01-14T22:04:43.703Z","id":"Q_rWAscQKNlueUeA4dLJk","name":"Cerebro bot","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"whatsapp-webhook","options":{}},"id":"9527da20-c731-437f-8a5e-d738e70f12ad","name":"Webhook WhatsApp","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-1216,192],"webhookId":"whatsapp-webhook"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ‘‹ Â¡Bienvenido!\"\n    },\n    \"body\": {\n      \"text\": \"Soy tu asistente virtual. Â¿En quÃ© puedo ayudarte hoy?\"\n    },\n    \"footer\": {\n      \"text\": \"Selecciona una opciÃ³n ðŸ‘‡\"\n    },\n    \"action\": {\n      \"button\": \"Ver MenÃº\",\n      \"sections\": [\n        {\n          \"title\": \"Servicios\",\n          \"rows\": [\n            {\n              \"id\": \"menu_impresiones\",\n              \"title\": \"ðŸ–¨ï¸ Impresiones\",\n              \"description\": \"Enviar archivos PDF\"\n            },\n            {\n              \"id\": \"menu_productos\",\n              \"title\": \"ðŸ” Buscar Productos\",\n              \"description\": \"Consultar precios\"\n            },\n            {\n              \"id\": \"menu_servicios\",\n              \"title\": \"ðŸ’¡ Pagos y TrÃ¡mites\",\n              \"description\": \"Luz, Agua, Gobierno\"\n            },\n             {\n              \"id\": \"menu_admin\",\n              \"title\": \"ðŸ“‚ AdministraciÃ³n\",\n              \"description\": \"Facturas y Quejas\"\n            }\n          ]\n        }\n      ]\n    }\n  }\n}","options":{}},"id":"9e4bccda-f2a3-471d-b453-d13385e46e2f","name":"Enviar MenÃº (HTTP)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-384,48],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.entry[0].changes[0].value.messages[0].text.body.toLowerCase() }}","operation":"contains","value2":"hola"},{"value1":"={{ $json.body.entry[0].changes[0].value.messages[0].text.body.toLowerCase() }}","operation":"contains","value2":"menu"},{"value1":"={{ $json.body.entry[0].changes[0].value.messages[0].text.body.toLowerCase() }}","operation":"contains","value2":"inicio"}]},"combineOperation":"any"},"id":"b1f40a9f-403a-44d3-b6f9-f6282ff0b24f","name":"Â¿Es Saludo o BÃºsqueda?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-640,128]},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?gid=0#gid=0","mode":"url"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Productos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=0"},"options":{}},"id":"9f1a277f-a4ff-420c-96b8-6c0b59b53d77","name":"Leer Todos los Productos","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[-48,880],"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.json_para_whatsapp }}","options":{}},"id":"a5a75a4d-a091-4a60-9a0e-21eab82ef1c9","name":"Enviar No Encontrado","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[592,912],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","value2":"document"}]}},"id":"794eeb03-b5a9-4637-9a0a-695a9f9affa0","name":"Â¿Es un Documento?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-608,-80]},{"parameters":{"url":"=https://graph.facebook.com/v17.0/{{ $json.body.entry[0].changes[0].value.messages[0].document.id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"}]},"options":{}},"id":"168425ef-7670-48ce-92d3-52ea50b8f45e","name":"Obtener URL de Descarga","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-400,-176],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"url":"={{ $json.url }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"}]},"options":{}},"id":"03483cd4-2d08-466b-97bd-788a0e9409e4","name":"Descargar PDF","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-176,-176],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"method":"POST","url":"http://172.17.0.1:8000/analizar-pdf","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{}},"id":"9f349949-949f-49b9-b3eb-a76735f4e210","name":"Enviar a Python","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[48,-176]},{"parameters":{"authentication":"serviceAccount","operation":"append","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1911314986,"mode":"list","cachedResultName":"OrdenesTemp","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1911314986"},"columns":{"mappingMode":"defineBelow","value":{"telefono":"={{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from }}","paginas":"={{ $json.paginas }}","status":"Pendiente","fecha":"={{ new Date().toISOString() }}","pdf_id":"={{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].document.id }}"},"matchingColumns":[],"schema":[{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"paginas","displayName":"paginas","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"pdf_id","displayName":"pdf_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"3a99ea28-1965-49b5-a907-489df5985d88","name":"Guardar en Memoria","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[288,-176],"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"ðŸ“„ *Archivo Analizado: {{ $('Enviar a Python').item.json.filename }}*\\nDetectÃ© *{{ $('Enviar a Python').item.json.paginas }} pÃ¡ginas*.\\n\\nPara darte el precio exacto, dime:\\nÂ¿CÃ³mo lo necesitas?\\n\\n_Ejemplos:_\\n- \\\"2 juegos a color en opalina\\\"\\n- \\\"1 juego blanco y negro engargolado\\\"\\n- \\\"Todo en bond color\\\"\"\n  }\n}","options":{}},"id":"8bec3083-4cb2-4965-9795-5dcafd52d66d","name":"Preguntar Detalles","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[512,-176],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1911314986,"mode":"list","cachedResultName":"OrdenesTemp","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1911314986"},"options":{}},"id":"b67b28ab-2944-476f-a08b-bb1dc9074c79","name":"Buscar Ordenes Pendientes","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[-320,304],"alwaysOutputData":true,"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// 1. Obtener telÃ©fono del usuario (Webhook)\nconst rawTel = $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from;\n// Limpiamos el telÃ©fono (solo dejamos nÃºmeros) por seguridad\nconst telefonoUsuario = String(rawTel).replace(/\\D/g, ''); \n\n// 2. Obtener Ã³rdenes del Excel\nconst ordenes = $input.all().map(i => i.json);\n\n// 3. Buscar coincidencia robusta\nconst ordenUsuario = ordenes.reverse().find(o => {\n  // Limpiamos tambiÃ©n el telÃ©fono del Excel por si Google lo cambiÃ³\n  const telExcel = String(o.telefono || '').replace(/\\D/g, '');\n  const status = (o.status || '').toString().toLowerCase().trim();\n  \n  // Comparamos\n  return telExcel === telefonoUsuario && status === 'pendiente';\n});\n\nif (ordenUsuario) {\n  // Si encontrÃ³, devolvemos TRUE y los datos\n  return { json: { existe: true, ...ordenUsuario } };\n} else {\n  // DEBUG: Si falla, devuelve quÃ© buscÃ³ para que podamos ver el error en el output\n  return { \n      json: { \n          existe: false, \n          debug_buscaba: telefonoUsuario, \n          debug_encontro_ultimo: ordenes.length > 0 ? ordenes[0].telefono : 'lista_vacia'\n      } \n  };\n}"},"id":"257baab0-a76f-4be1-8802-3215be9ff3eb","name":"Verificar Pendiente","type":"n8n-nodes-base.code","typeVersion":2,"position":[-112,288]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.existe }}","value2":true}]}},"id":"4e46c654-e89c-4da2-a1f1-193dc1adb554","name":"Â¿Es CotizaciÃ³n?","type":"n8n-nodes-base.if","typeVersion":1,"position":[112,288]},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1942709387,"mode":"list","cachedResultName":"Precios_Base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1942709387"},"options":{}},"id":"76c3a949-1a60-4d40-ba21-844ae0e3d7d0","name":"Leer Matriz Precios","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[304,272],"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// 1. RECUPERAR DATOS DE FORMA SEGURA (Blindaje contra errores)\nconst webhookData = $('Webhook WhatsApp').first().json.body.entry[0].changes[0].value.messages[0];\n\n// Usamos un \"operador ternario\" (preguntar ? si : no) para evitar el error rojo\n// Si trae texto, lo usamos. Si trae PDF/BotÃ³n, usamos texto vacÃ­o para no romper el flujo.\nconst textoUsuario = webhookData.text ? webhookData.text.body.toLowerCase() : '';\n\nconst orden = $('Verificar Pendiente').first().json;\n\n// 2. RECUPERAR PRECIOS (Esto sÃ­ viene del input directo)\nconst matrizPrecios = $input.all().map(i => i.json);\n\n// 3. LÃ“GICA DE DETECCIÃ“N (EL CEREBRO)\nlet precioPapel = 0;\nlet precioImpresion = 0;\nlet precioExtras = 0;\nlet cantidadJuegos = 1;\nlet detalles = [];\n\n// A) Detectar Cantidad\nconst matchCantidad = textoUsuario.match(/(\\d+)\\s*(juegos|copias|tantos|paquetes|juego|copia)/);\nif (matchCantidad) cantidadJuegos = parseInt(matchCantidad[1]);\n\n// B) Buscar Coincidencias en Matriz\nmatrizPrecios.forEach(prod => {\n    if (prod.palabras_clave) {\n        const keywords = prod.palabras_clave.toString().toLowerCase().split(',').map(k => k.trim());\n        const encontrado = keywords.some(kw => textoUsuario.includes(kw));\n        \n        if (encontrado) {\n            detalles.push(prod.nombre_comercial);\n            if (prod.categoria === 'papel') precioPapel = Math.max(precioPapel, parseFloat(prod.precio));\n            if (prod.categoria === 'impresion') precioImpresion = Math.max(precioImpresion, parseFloat(prod.precio));\n            if (prod.categoria === 'extra') precioExtras += parseFloat(prod.precio);\n        }\n    }\n});\n\n// C) Defaults\nif (precioPapel === 0) { precioPapel = 0.5; detalles.push(\"Papel Bond (Default)\"); }\nif (precioImpresion === 0) { precioImpresion = 1.5; detalles.push(\"B/N (Default)\"); }\n\n// 4. CÃLCULO MATEMÃTICO\nconst paginas = parseInt(orden.paginas || 0);\nconst costoPorJuego = (paginas * (precioPapel + precioImpresion)) + precioExtras;\nconst granTotal = costoPorJuego * cantidadJuegos;\n\nreturn {\n  json: {\n    telefono: orden.telefono,\n    paginas: paginas,\n    resumen: detalles.join(' + '),\n    juegos: cantidadJuegos,\n    unitario: costoPorJuego,\n    total: granTotal\n  }\n};"},"id":"0dc997da-4971-4413-9624-8cbe0a1f4474","name":"Calcular Total","type":"n8n-nodes-base.code","typeVersion":2,"position":[528,272]},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ¢ Selecciona tu Sucursal\"\n    },\n    \"body\": {\n      \"text\": \"Â¿A cuÃ¡l sucursal pasarÃ¡s a recoger tu pedido?\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sucursal_calzada\",\n            \"title\": \"ðŸ“ Calzada\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sucursal_centro\",\n            \"title\": \"ðŸ“ Centro\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sucursal_16\",\n            \"title\": \"ðŸ“ 16 de Sept.\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{}},"id":"86cf59b0-029c-41de-a394-5ea03959597e","name":"Preguntar Sucursal","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1104,-80],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1911314986,"mode":"list","cachedResultName":"OrdenesTemp","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1911314986"},"options":{}},"id":"85cb34fb-0e39-4a83-95a4-efa0a0cd1014","name":"Recuperar PDF ID","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[1392,112],"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// 1. RECUPERAR DATOS SEGUROS\nconst webhookData = $('Webhook WhatsApp').first().json.body.entry[0].changes[0].value.messages[0];\nconst telefonoCliente = webhookData.from;\n\n// 2. RECUPERAR ID DEL BOTÃ“N Y LIMPIARLO\nconst seleccionRaw = webhookData.interactive.button_reply.id;\nconst seleccion = String(seleccionRaw).trim();\n\n// ðŸ›‘ FRENO DE EMERGENCIA ðŸ›‘\nif (seleccion === 'confirmar_orden') {\n    return [];\n}\n\n// 3. RECUPERAR PDF ID Y NÃšMERO DE FILA\nconst ordenes = $input.all().map(i => i.json);\nconst orden = ordenes.reverse().find(o => String(o.telefono).replace(/\\D/g, '') === String(telefonoCliente).replace(/\\D/g, ''));\n\n// 4. ASIGNAR SUCURSAL\nlet telefonoSucursal = '';\nlet nombreSucursal = '';\n\n// Â¡OJO! AsegÃºrate de que estos telÃ©fonos sean los correctos\nif (seleccion === 'sucursal_calzada') {\n    telefonoSucursal = '5218421082820'; \n    nombreSucursal = 'Calzada del MarquÃ©s';\n} else if (seleccion === 'sucursal_centro') {\n    telefonoSucursal = '5218421082820'; \n    nombreSucursal = 'Centro';\n} else if (seleccion === 'sucursal_16') {\n    telefonoSucursal = '5218421082820'; \n    nombreSucursal = '16 de Septiembre';\n} else {\n    telefonoSucursal = '5218421082820'; \n    nombreSucursal = 'Sucursal Central';\n}\n\nreturn {\n    json: {\n        telefono_cliente: telefonoCliente,\n        telefono_sucursal: telefonoSucursal,\n        nombre_sucursal: nombreSucursal,\n        pdf_id: orden ? orden.pdf_id : \"NO_ENCONTRADO\",\n        row_number: orden ? orden.row_number : null, // <--- Â¡ESTA ES LA CLAVE NUEVA!\n        detalles: \"Pedido confirmado\"\n    }\n};"},"id":"02bfb6ac-dcfa-41ec-ad1b-417ccc4fa7ff","name":"Preparar EnvÃ­o","type":"n8n-nodes-base.code","typeVersion":2,"position":[1728,128]},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefono_sucursal }}\",\n  \"type\": \"document\",\n  \"document\": {\n    \"id\": \"{{ $json.pdf_id }}\",\n    \"caption\": \"ðŸš¨ *NUEVO PEDIDO AUTORIZADO*\\n\\nCliente: {{ $json.telefono_cliente }}\\nSucursal Destino: *{{ $json.nombre_sucursal }}*\\n\\nâš ï¸ *Imprimir de inmediato.*\"\n  }\n}","options":{}},"id":"1fce9cf0-6a8f-4580-93cb-cf511500a2ea","name":"Enviar PDF a Sucursal","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1968,16],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefono_cliente }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"âœ… *Â¡Todo Listo!*\\n\\nYa enviÃ© tu archivo a la sucursal *{{ $json.nombre_sucursal }}*.\\n\\nLo estarÃ¡n imprimiendo ahora mismo. Puedes pasar a recogerlo en caja mencionando tu nÃºmero.\\n\\n_Â¡Gracias por tu preferencia!_\"\n  }\n}","options":{}},"id":"168d7320-3278-449c-aa45-db425341045e","name":"Avisar al Cliente","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1968,240],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefono }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ’° CotizaciÃ³n Lista\"\n    },\n    \"body\": {\n      \"text\": \"âœ… *He entendido tu pedido:*\\n\\nðŸ“„ Documento: {{ $json.paginas }} pÃ¡ginas\\nðŸ› ï¸ Detalles: {{ $json.resumen }}\\nðŸ“¦ Cantidad: *{{ $json.juegos }} juegos*\\n\\nðŸ’µ *TOTAL A PAGAR: ${{ $json.total }}*\\n_(Precio por juego: ${{ $json.unitario }})_\\n\\nÂ¿Todo correcto? Presiona continuar para elegir sucursal.\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"confirmar_orden\",\n            \"title\": \"âœ… SÃ­, Continuar\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"cancelar_orden\",\n            \"title\": \"âŒ Cancelar\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{}},"id":"fb8b0dfb-6a82-4e4d-92cb-7788a7c270db","name":"Enviar CotizaciÃ³n","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[720,336],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"490d0047-2053-48ba-9cf7-963b7cc57a19","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"confirmar_orden","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"91ece125-8153-487e-91f5-4a949e39e4d1","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"sucursal_calzada","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"32d08040-3a2e-4b6f-934c-857cf17b9a5c","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"sucursal_centro","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"ca4ac786-2b59-4c51-97f4-71e80d1f8f1c","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"sucursal_16","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"0b73690b-f4c8-4a67-83b3-43c39e53da37","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"cancelar_orden","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[704,32],"id":"34a3448c-763a-4a91-839a-9ac88ddbd3ee","name":"Switch"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","rightValue":"=document","operator":{"type":"string","operation":"equals"},"id":"96f789f1-41a1-4757-990e-01621279ac80"}],"combinator":"and"},"renameOutput":true,"outputKey":"0"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"90dcfaaa-7bae-4599-88ec-dcc54ef7fca7","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"0"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"e0249303-5f1d-4000-9f26-01c2ed306d39","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","rightValue":"text","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"1"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"b45dedb0-21d1-4525-a0b0-32eb884acc82","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","rightValue":"interactive","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"2"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-880,144],"id":"d09e02d5-c31d-464f-bbcc-fc60469e7c90","name":"tipo de mensaje"},{"parameters":{"authentication":"serviceAccount","operation":"delete","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1911314986,"mode":"list","cachedResultName":"OrdenesTemp","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1911314986"},"startIndex":"={{ $('Preparar EnvÃ­o').first().json.row_number }}"},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2240,32],"id":"a6e951b1-cf60-472c-8812-8923af749a3f","name":"Delete rows or columns from sheet","credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// ==========================================\n// ðŸš€ MOTOR DE BÃšSQUEDA INTELIGENTE V3.0\n// ==========================================\n\n// ==========================================\n// ðŸ“š CONFIGURACIÃ“N Y DICCIONARIOS\n// ==========================================\n\nconst CONFIG = {\n    umbralMinimo: 0.35,\n    maxResultados: 5,\n    pesoAncla: 0.4,\n    pesoCobertura: 0.35,\n    pesoOrden: 0.15,\n    pesoExactitud: 0.10\n};\n\nconst DICCIONARIO = {\n    // Servicios\n    \"luz\": [\"cfe\", \"comision\", \"electricidad\", \"recibo\", \"corriente\"],\n    \"agua\": [\"aguakan\", \"capa\", \"sas\", \"potable\", \"hidrico\"],\n    \"internet\": [\"telmex\", \"modem\", \"wifi\", \"megacable\", \"red\", \"infinitum\"],\n    \n    // Productos papelerÃ­a\n    \"lapiz\": [\"lÃ¡piz\", \"mirado\", \"grafito\", \"bicolor\", \"dixon\", \"numero\"],\n    \"pluma\": [\"boligrafo\", \"lapicero\", \"tinta\", \"punto\", \"bic\", \"kilometrico\"],\n    \"goma\": [\"borrador\", \"miga\", \"factis\", \"migajon\", \"pelikan\"],\n    \"diurex\": [\"cinta\", \"adhesiva\", \"scotch\", \"janel\", \"canela\", \"transparente\"],\n    \"hojas\": [\"papel\", \"bond\", \"carta\", \"oficio\", \"resma\", \"opalina\", \"blancas\"],\n    \"libreta\": [\"cuaderno\", \"profesional\", \"forma\", \"francesa\", \"italiana\", \"cosida\", \"spiral\", \"scribe\", \"rayado\"],\n    \"colores\": [\"caja\", \"pinturas\", \"madera\", \"maped\", \"norma\", \"vividel\", \"blanca\", \"nieves\", \"crayola\"],\n    \"marcador\": [\"plumon\", \"sharpie\", \"texto\", \"agua\", \"aceite\", \"permanente\", \"pilot\"],\n    \"regla\": [\"30cm\", \"metal\", \"plastico\", \"graduada\"],\n    \"tijeras\": [\"escolares\", \"punta\", \"redonda\", \"metalicas\"],\n    \"resistol\": [\"pegamento\", \"blanco\", \"liquido\", \"barra\", \"kola\", \"loka\"],\n    \"corrector\": [\"liquid\", \"paper\", \"cinta\", \"lapiz\"],\n    \n    // Atributos\n    \"numero\": [\"no\", \"num\", \"#\", \"calibre\"],\n    \"caja\": [\"paquete\", \"juego\", \"estuche\", \"set\"],\n    \"pieza\": [\"suelta\", \"unidad\", \"pz\", \"individual\"],\n    \"economico\": [\"barato\", \"sencillo\", \"escolar\", \"chafa\"]\n};\n\n// PALABRAS DE RELLENO EXPANDIDAS (lenguaje coloquial mexicano)\nconst STOPWORDS = new Set([\n    // Saludos\n    \"hola\", \"buenos\", \"dias\", \"tardes\", \"noches\", \"buenas\", \"que\", \"onda\",\n    \n    // Verbos de solicitud\n    \"venden\", \"venen\", \"vendes\", \"vendran\", \"vende\",\n    \"tendras\", \"tendra\", \"tendran\",\n    \"tienes\", \"tiene\", \"tienen\", \"tuviera\",\n    \"quisiera\", \"quiero\", \"queria\", \"querria\",\n    \"necesito\", \"necesitas\", \"necesita\", \"ocupo\", \"ocupas\", \"ocupa\", // â† COLOQUIAL\n    \"busco\", \"buscas\", \"busca\",\n    \"puedo\", \"puede\", \"pueden\", \"podria\", \"podrias\",\n    \"haber\", \"hay\", \"habra\",\n    \"dame\", \"deme\", \"danos\", \"das\", \"da\", \"den\", // â† COLOQUIAL\n    \"pagar\", \"cobrar\", \"costar\",\n    \n    // Preguntas\n    \"precio\", \"costo\", \"cuanto\", \"cuantos\", \"cuanta\", \"sale\", \"salen\",\n    \"cotizame\", \"cotiza\", \"cotizacion\",\n    \"disponible\", \"existencia\", \"stock\",\n    \n    // ArtÃ­culos y conectores\n    \"el\", \"la\", \"los\", \"las\", \"un\", \"una\", \"unos\", \"unas\",\n    \"de\", \"del\", \"al\", \"para\", \"por\", \"con\", \"sin\", \"y\", \"o\", \"que\", \"si\",\n    \"me\", \"te\", \"le\", \"mi\", \"mis\", \"sus\", \"su\", \"tu\", \"tus\",\n    \n    // CortesÃ­a\n    \"favor\", \"gracias\", \"please\", \"porfavor\", \"porfa\",\n    \"disculpa\", \"disculpe\", \"oye\", \"oiga\",\n    \n    // Otros\n    \"algun\", \"alguna\", \"algunos\", \"tipo\", \"tipos\", \"marca\", \"marcas\"\n]);\n\n// ==========================================\n// ðŸ”§ UTILIDADES CORE\n// ==========================================\n\nclass TextProcessor {\n    static normalizar(texto) {\n        if (!texto) return '';\n        return texto.toString().toLowerCase()\n            .normalize(\"NFD\")\n            .replace(/[\\u0300-\\u036f]/g, \"\")\n            .replace(/[^a-z0-9 ]/g, \" \")\n            .replace(/\\s+/g, \" \")\n            .trim();\n    }\n    \n    static tokenizar(texto) {\n        return this.normalizar(texto)\n            .split(\" \")\n            .filter(p => p.length > 0 && !STOPWORDS.has(p));\n    }\n    \n    static expandirSinonimos(palabra) {\n        const variaciones = new Set([palabra]);\n        \n        for (const [concepto, sinonimos] of Object.entries(DICCIONARIO)) {\n            if (concepto === palabra || sinonimos.includes(palabra)) {\n                variaciones.add(concepto);\n                sinonimos.forEach(s => variaciones.add(s));\n            }\n        }\n        \n        return Array.from(variaciones);\n    }\n    \n    // Distancia de Levenshtein optimizada\n    static similitud(s1, s2) {\n        if (s1 === s2) return 1.0;\n        if (s1.length === 0 || s2.length === 0) return 0.0;\n        \n        let longer = s1.length > s2.length ? s1 : s2;\n        let shorter = s1.length > s2.length ? s2 : s1;\n        \n        const longerLen = longer.length;\n        const costs = Array(shorter.length + 1).fill(0).map((_, i) => i);\n        \n        for (let i = 1; i <= longerLen; i++) {\n            let prev = i;\n            for (let j = 1; j <= shorter.length; j++) {\n                let current;\n                if (longer[i-1] === shorter[j-1]) {\n                    current = costs[j-1];\n                } else {\n                    current = Math.min(costs[j-1], prev, costs[j]) + 1;\n                }\n                costs[j-1] = prev;\n                prev = current;\n            }\n            costs[shorter.length] = prev;\n        }\n        \n        return 1 - (costs[shorter.length] / longerLen);\n    }\n}\n\n// ==========================================\n// ðŸ—‚ï¸ ÃNDICE DE PRODUCTOS (CACHÃ‰)\n// ==========================================\n\nclass ProductIndex {\n    constructor() {\n        this.productos = [];\n        this.indiceInvertido = new Map(); // palabra -> [ids productos]\n        this.cache = new Map();\n    }\n    \n    indexar(productos) {\n        this.productos = productos.map((item, idx) => {\n            const datos = item.json;\n            const keys = Object.keys(datos);\n            \n            const keyNombre = keys.find(k => /nombre|producto|descripcion/i.test(k));\n            const keyPrecio = keys.find(k => /precio|costo|amount/i.test(k));\n            \n            const nombreOriginal = keyNombre ? datos[keyNombre] : '';\n            const precio = keyPrecio ? parseFloat(datos[keyPrecio]) : 0;\n            \n            const tokens = TextProcessor.tokenizar(nombreOriginal);\n            \n            // Construir Ã­ndice invertido\n            tokens.forEach(token => {\n                if (!this.indiceInvertido.has(token)) {\n                    this.indiceInvertido.set(token, []);\n                }\n                this.indiceInvertido.get(token).push(idx);\n            });\n            \n            return {\n                id: idx,\n                nombreOriginal: nombreOriginal.toString().replace(/\"/g, \"\").replace(/\\n/g, \" \"),\n                tokens,\n                precio: isNaN(precio) ? 0 : precio,\n                datosOriginales: datos\n            };\n        });\n    }\n    \n    // Obtener candidatos usando Ã­ndice invertido (mucho mÃ¡s rÃ¡pido)\n    obtenerCandidatos(tokensQuery) {\n        const candidatosSet = new Set();\n        \n        tokensQuery.forEach(token => {\n            const variaciones = TextProcessor.expandirSinonimos(token);\n            \n            variaciones.forEach(variacion => {\n                // BÃºsqueda exacta en Ã­ndice\n                if (this.indiceInvertido.has(variacion)) {\n                    this.indiceInvertido.get(variacion).forEach(id => candidatosSet.add(id));\n                }\n                \n                // BÃºsqueda fuzzy en Ã­ndice (solo para palabras largas)\n                if (variacion.length >= 4) {\n                    for (const [palabraIndice, ids] of this.indiceInvertido.entries()) {\n                        if (TextProcessor.similitud(variacion, palabraIndice) > 0.8) {\n                            ids.forEach(id => candidatosSet.add(id));\n                        }\n                    }\n                }\n            });\n        });\n        \n        return Array.from(candidatosSet).map(id => this.productos[id]);\n    }\n}\n\n// ==========================================\n// ðŸŽ¯ MOTOR DE SCORING\n// ==========================================\n\nclass ScoringEngine {\n    static calcular(producto, tokensQuery, palabraAncla) {\n        let scores = {\n            ancla: 0,\n            cobertura: 0,\n            orden: 0,\n            exactitud: 0\n        };\n        \n        const tokensProducto = producto.tokens;\n        let conceptosEncontrados = 0;\n        let scoreAcumulado = 0;\n        \n        tokensQuery.forEach((tokenQuery, indexQuery) => {\n            const variaciones = TextProcessor.expandirSinonimos(tokenQuery);\n            let mejorMatch = 0;\n            let posicionEncontrada = -1;\n            \n            tokensProducto.forEach((tokenProd, indexProd) => {\n                variaciones.forEach(variacion => {\n                    let score;\n                    \n                    // NÃºmeros y palabras cortas: match exacto\n                    if (!isNaN(variacion) || variacion.length <= 2) {\n                        score = tokenProd === variacion ? 1.0 : 0;\n                    } else {\n                        score = TextProcessor.similitud(variacion, tokenProd);\n                    }\n                    \n                    if (score > mejorMatch) {\n                        mejorMatch = score;\n                        posicionEncontrada = indexProd;\n                    }\n                });\n            });\n            \n            if (mejorMatch > 0.75) {\n                conceptosEncontrados++;\n                scoreAcumulado += mejorMatch;\n                \n                // Score del ancla\n                if (indexQuery === 0 && palabraAncla) {\n                    scores.ancla = mejorMatch;\n                }\n                \n                // Score de orden (bonus si aparece en orden similar)\n                if (posicionEncontrada >= 0) {\n                    const diferenciaOrden = Math.abs(indexQuery - posicionEncontrada);\n                    scores.orden += (1 / (1 + diferenciaOrden)) * mejorMatch;\n                }\n            }\n        });\n        \n        // Cobertura: quÃ© % de conceptos del usuario se encontraron\n        scores.cobertura = tokensQuery.length > 0 \n            ? conceptosEncontrados / tokensQuery.length \n            : 0;\n        \n        // Exactitud: quÃ© tan bien matchearon en promedio\n        scores.exactitud = tokensQuery.length > 0 \n            ? scoreAcumulado / tokensQuery.length \n            : 0;\n        \n        // Normalizar orden\n        scores.orden = tokensQuery.length > 0 \n            ? scores.orden / tokensQuery.length \n            : 0;\n        \n        // Score final ponderado\n        const scoreFinal = \n            (scores.ancla * CONFIG.pesoAncla) +\n            (scores.cobertura * CONFIG.pesoCobertura) +\n            (scores.orden * CONFIG.pesoOrden) +\n            (scores.exactitud * CONFIG.pesoExactitud);\n        \n        // Bonus por cobertura completa\n        const bonus = scores.cobertura === 1.0 ? 0.15 : 0;\n        \n        return {\n            total: Math.min(scoreFinal + bonus, 1.0),\n            desglose: scores\n        };\n    }\n}\n\n// ==========================================\n// ðŸ” MOTOR PRINCIPAL\n// ==========================================\n\nclass SearchEngine {\n    constructor() {\n        this.indice = new ProductIndex();\n    }\n    \n    indexarProductos(productos) {\n        this.indice.indexar(productos);\n    }\n    \n    buscar(query) {\n        const tokensQuery = TextProcessor.tokenizar(query);\n        \n        if (tokensQuery.length === 0) {\n            return {\n                encontrado: false,\n                resultados: [],\n                debug: {\n                    tokensQuery: [],\n                    mensaje: \"No se detectaron palabras vÃ¡lidas\"\n                }\n            };\n        }\n        \n        const palabraAncla = tokensQuery[0];\n        \n        // Obtener candidatos usando Ã­ndice invertido (RÃPIDO)\n        const candidatos = this.indice.obtenerCandidatos(tokensQuery);\n        \n        // Calcular scores solo para candidatos\n        const resultados = candidatos.map(producto => {\n            const scoring = ScoringEngine.calcular(producto, tokensQuery, palabraAncla);\n            \n            return {\n                ...producto,\n                score: scoring.total,\n                scoreDesglose: scoring.desglose\n            };\n        });\n        \n        // Filtrar y ordenar\n        const filtrados = resultados\n            .filter(r => r.score >= CONFIG.umbralMinimo)\n            .sort((a, b) => b.score - a.score)\n            .slice(0, CONFIG.maxResultados);\n        \n        return {\n            encontrado: filtrados.length > 0,\n            resultados: filtrados,\n            debug: {\n                tokensQuery,\n                palabraAncla,\n                candidatosEvaluados: candidatos.length,\n                resultadosFiltrados: filtrados.length\n            }\n        };\n    }\n}\n\n// ==========================================\n// ðŸš€ EJECUCIÃ“N PRINCIPAL\n// ==========================================\n\n// 1. Obtener mensaje de WhatsApp\nlet telefono = \"\", mensajeOriginal = \"\";\ntry {\n    const data = $('Webhook WhatsApp').first().json.body.entry[0].changes[0].value.messages[0];\n    mensajeOriginal = data.text.body;\n    telefono = data.from;\n} catch (e) {\n    mensajeOriginal = \"\";\n    telefono = \"520000000000\";\n}\n\n// 2. Inicializar motor\nconst motor = new SearchEngine();\nmotor.indexarProductos($input.all());\n\n// 3. Buscar\nconst resultado = motor.buscar(mensajeOriginal);\n\n// 4. Generar respuesta WhatsApp\nlet mensajeTexto = \"\";\n\nif (!resultado.encontrado) {\n    mensajeTexto = `âŒ *No encontrÃ© resultados exactos.*\\n\\n` +\n                   `Intenta con palabras simples como:\\n` +\n                   `_\"LÃ¡piz\"_, _\"Cuaderno\"_, _\"Colores\"_\\n\\n` +\n                   `_(BusquÃ©: ${resultado.debug.tokensQuery.join(\" + \")})_`;\n} else {\n    mensajeTexto = `âœ… *EncontrÃ© ${resultado.resultados.length} opciones:*\\n\\n`;\n    \n    resultado.resultados.forEach((prod, idx) => {\n        mensajeTexto += `${idx + 1}. *${prod.nombreOriginal}*\\n`;\n        mensajeTexto += `   ðŸ’° $${prod.precio.toFixed(2)}\\n`;\n        mensajeTexto += `   ðŸ“Š Relevancia: ${(prod.score * 100).toFixed(0)}%\\n\\n`;\n    });\n    \n    mensajeTexto += \"ðŸ‘‡ *Escribe el nombre exacto del producto o envÃ­a foto para ordenar.*\";\n}\n\nconst bodyObject = {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": telefono,\n    \"type\": \"text\",\n    \"text\": { \"body\": mensajeTexto }\n};\n\n// 5. Retornar resultado\nreturn [{\n    json: {\n        encontrado: resultado.encontrado,\n        json_para_whatsapp: JSON.stringify(bodyObject),\n        debug_query: mensajeOriginal,\n        debug_tokens: resultado.debug.tokensQuery.join(\" + \"),\n        debug_candidatos: resultado.debug.candidatosEvaluados,\n        debug_top_match: resultado.encontrado ? resultado.resultados[0].nombreOriginal : \"Nada\",\n        debug_top_score: resultado.encontrado ? resultado.resultados[0].score.toFixed(3) : \"0\"\n    }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[208,912],"id":"6c1dfb41-4d6d-4d16-b7bb-d801b87fefd9","name":"Code in JavaScript1"}],"connections":{"Webhook WhatsApp":{"main":[[{"node":"tipo de mensaje","type":"main","index":0}]]},"Â¿Es Saludo o BÃºsqueda?":{"main":[[{"node":"Enviar MenÃº (HTTP)","type":"main","index":0}],[{"node":"Buscar Ordenes Pendientes","type":"main","index":0}]]},"Leer Todos los Productos":{"main":[[{"node":"Code in JavaScript1","type":"main","index":0}]]},"Enviar MenÃº (HTTP)":{"main":[[]]},"Â¿Es un Documento?":{"main":[[{"node":"Obtener URL de Descarga","type":"main","index":0}],[]]},"Obtener URL de Descarga":{"main":[[{"node":"Descargar PDF","type":"main","index":0}]]},"Descargar PDF":{"main":[[{"node":"Enviar a Python","type":"main","index":0}]]},"Enviar a Python":{"main":[[{"node":"Guardar en Memoria","type":"main","index":0}]]},"Guardar en Memoria":{"main":[[{"node":"Preguntar Detalles","type":"main","index":0}]]},"Buscar Ordenes Pendientes":{"main":[[{"node":"Verificar Pendiente","type":"main","index":0}]]},"Verificar Pendiente":{"main":[[{"node":"Â¿Es CotizaciÃ³n?","type":"main","index":0}]]},"Â¿Es CotizaciÃ³n?":{"main":[[{"node":"Leer Matriz Precios","type":"main","index":0}],[{"node":"Leer Todos los Productos","type":"main","index":0}]]},"Leer Matriz Precios":{"main":[[{"node":"Calcular Total","type":"main","index":0}]]},"Calcular Total":{"main":[[{"node":"Enviar CotizaciÃ³n","type":"main","index":0}]]},"Recuperar PDF ID":{"main":[[{"node":"Preparar EnvÃ­o","type":"main","index":0}]]},"Preparar EnvÃ­o":{"main":[[{"node":"Enviar PDF a Sucursal","type":"main","index":0},{"node":"Avisar al Cliente","type":"main","index":0}]]},"Enviar CotizaciÃ³n":{"main":[[]]},"Preguntar Sucursal":{"main":[[{"node":"Recuperar PDF ID","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Preguntar Sucursal","type":"main","index":0}],[{"node":"Recuperar PDF ID","type":"main","index":0}],[{"node":"Recuperar PDF ID","type":"main","index":0}],[{"node":"Recuperar PDF ID","type":"main","index":0}],[]]},"tipo de mensaje":{"main":[[{"node":"Â¿Es un Documento?","type":"main","index":0}],[{"node":"Â¿Es un Documento?","type":"main","index":0}],[{"node":"Â¿Es Saludo o BÃºsqueda?","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"Enviar PDF a Sucursal":{"main":[[{"node":"Delete rows or columns from sheet","type":"main","index":0}]]},"Avisar al Cliente":{"main":[[]]},"Code in JavaScript1":{"main":[[{"node":"Enviar No Encontrado","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"a801897f-0c84-4bca-8d70-b1738e978aca","activeVersionId":"a801897f-0c84-4bca-8d70-b1738e978aca","triggerCount":1,"shared":[{"updatedAt":"2026-01-14T22:04:43.706Z","createdAt":"2026-01-14T22:04:43.706Z","role":"workflow:owner","workflowId":"Q_rWAscQKNlueUeA4dLJk","projectId":"6XQHFhZ2nguxJcVZ"}],"activeVersion":{"updatedAt":"2026-01-20T05:07:06.000Z","createdAt":"2026-01-20T05:07:02.957Z","versionId":"a801897f-0c84-4bca-8d70-b1738e978aca","workflowId":"Q_rWAscQKNlueUeA4dLJk","nodes":[{"parameters":{"httpMethod":"POST","path":"whatsapp-webhook","options":{}},"id":"9527da20-c731-437f-8a5e-d738e70f12ad","name":"Webhook WhatsApp","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-1216,192],"webhookId":"whatsapp-webhook"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ‘‹ Â¡Bienvenido!\"\n    },\n    \"body\": {\n      \"text\": \"Soy tu asistente virtual. Â¿En quÃ© puedo ayudarte hoy?\"\n    },\n    \"footer\": {\n      \"text\": \"Selecciona una opciÃ³n ðŸ‘‡\"\n    },\n    \"action\": {\n      \"button\": \"Ver MenÃº\",\n      \"sections\": [\n        {\n          \"title\": \"Servicios\",\n          \"rows\": [\n            {\n              \"id\": \"menu_impresiones\",\n              \"title\": \"ðŸ–¨ï¸ Impresiones\",\n              \"description\": \"Enviar archivos PDF\"\n            },\n            {\n              \"id\": \"menu_productos\",\n              \"title\": \"ðŸ” Buscar Productos\",\n              \"description\": \"Consultar precios\"\n            },\n            {\n              \"id\": \"menu_servicios\",\n              \"title\": \"ðŸ’¡ Pagos y TrÃ¡mites\",\n              \"description\": \"Luz, Agua, Gobierno\"\n            },\n             {\n              \"id\": \"menu_admin\",\n              \"title\": \"ðŸ“‚ AdministraciÃ³n\",\n              \"description\": \"Facturas y Quejas\"\n            }\n          ]\n        }\n      ]\n    }\n  }\n}","options":{}},"id":"9e4bccda-f2a3-471d-b453-d13385e46e2f","name":"Enviar MenÃº (HTTP)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-384,48],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.entry[0].changes[0].value.messages[0].text.body.toLowerCase() }}","operation":"contains","value2":"hola"},{"value1":"={{ $json.body.entry[0].changes[0].value.messages[0].text.body.toLowerCase() }}","operation":"contains","value2":"menu"},{"value1":"={{ $json.body.entry[0].changes[0].value.messages[0].text.body.toLowerCase() }}","operation":"contains","value2":"inicio"}]},"combineOperation":"any"},"id":"b1f40a9f-403a-44d3-b6f9-f6282ff0b24f","name":"Â¿Es Saludo o BÃºsqueda?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-640,128]},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?gid=0#gid=0","mode":"url"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Productos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=0"},"options":{}},"id":"9f1a277f-a4ff-420c-96b8-6c0b59b53d77","name":"Leer Todos los Productos","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[-48,880],"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.json_para_whatsapp }}","options":{}},"id":"a5a75a4d-a091-4a60-9a0e-21eab82ef1c9","name":"Enviar No Encontrado","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[592,912],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","value2":"document"}]}},"id":"794eeb03-b5a9-4637-9a0a-695a9f9affa0","name":"Â¿Es un Documento?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-608,-80]},{"parameters":{"url":"=https://graph.facebook.com/v17.0/{{ $json.body.entry[0].changes[0].value.messages[0].document.id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"}]},"options":{}},"id":"168425ef-7670-48ce-92d3-52ea50b8f45e","name":"Obtener URL de Descarga","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-400,-176],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"url":"={{ $json.url }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"}]},"options":{}},"id":"03483cd4-2d08-466b-97bd-788a0e9409e4","name":"Descargar PDF","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-176,-176],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"method":"POST","url":"http://172.17.0.1:8000/analizar-pdf","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{}},"id":"9f349949-949f-49b9-b3eb-a76735f4e210","name":"Enviar a Python","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[48,-176]},{"parameters":{"authentication":"serviceAccount","operation":"append","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1911314986,"mode":"list","cachedResultName":"OrdenesTemp","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1911314986"},"columns":{"mappingMode":"defineBelow","value":{"telefono":"={{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from }}","paginas":"={{ $json.paginas }}","status":"Pendiente","fecha":"={{ new Date().toISOString() }}","pdf_id":"={{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].document.id }}"},"matchingColumns":[],"schema":[{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"paginas","displayName":"paginas","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"pdf_id","displayName":"pdf_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"3a99ea28-1965-49b5-a907-489df5985d88","name":"Guardar en Memoria","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[288,-176],"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"ðŸ“„ *Archivo Analizado: {{ $('Enviar a Python').item.json.filename }}*\\nDetectÃ© *{{ $('Enviar a Python').item.json.paginas }} pÃ¡ginas*.\\n\\nPara darte el precio exacto, dime:\\nÂ¿CÃ³mo lo necesitas?\\n\\n_Ejemplos:_\\n- \\\"2 juegos a color en opalina\\\"\\n- \\\"1 juego blanco y negro engargolado\\\"\\n- \\\"Todo en bond color\\\"\"\n  }\n}","options":{}},"id":"8bec3083-4cb2-4965-9795-5dcafd52d66d","name":"Preguntar Detalles","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[512,-176],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1911314986,"mode":"list","cachedResultName":"OrdenesTemp","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1911314986"},"options":{}},"id":"b67b28ab-2944-476f-a08b-bb1dc9074c79","name":"Buscar Ordenes Pendientes","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[-320,304],"alwaysOutputData":true,"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// 1. Obtener telÃ©fono del usuario (Webhook)\nconst rawTel = $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from;\n// Limpiamos el telÃ©fono (solo dejamos nÃºmeros) por seguridad\nconst telefonoUsuario = String(rawTel).replace(/\\D/g, ''); \n\n// 2. Obtener Ã³rdenes del Excel\nconst ordenes = $input.all().map(i => i.json);\n\n// 3. Buscar coincidencia robusta\nconst ordenUsuario = ordenes.reverse().find(o => {\n  // Limpiamos tambiÃ©n el telÃ©fono del Excel por si Google lo cambiÃ³\n  const telExcel = String(o.telefono || '').replace(/\\D/g, '');\n  const status = (o.status || '').toString().toLowerCase().trim();\n  \n  // Comparamos\n  return telExcel === telefonoUsuario && status === 'pendiente';\n});\n\nif (ordenUsuario) {\n  // Si encontrÃ³, devolvemos TRUE y los datos\n  return { json: { existe: true, ...ordenUsuario } };\n} else {\n  // DEBUG: Si falla, devuelve quÃ© buscÃ³ para que podamos ver el error en el output\n  return { \n      json: { \n          existe: false, \n          debug_buscaba: telefonoUsuario, \n          debug_encontro_ultimo: ordenes.length > 0 ? ordenes[0].telefono : 'lista_vacia'\n      } \n  };\n}"},"id":"257baab0-a76f-4be1-8802-3215be9ff3eb","name":"Verificar Pendiente","type":"n8n-nodes-base.code","typeVersion":2,"position":[-112,288]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.existe }}","value2":true}]}},"id":"4e46c654-e89c-4da2-a1f1-193dc1adb554","name":"Â¿Es CotizaciÃ³n?","type":"n8n-nodes-base.if","typeVersion":1,"position":[112,288]},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1942709387,"mode":"list","cachedResultName":"Precios_Base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1942709387"},"options":{}},"id":"76c3a949-1a60-4d40-ba21-844ae0e3d7d0","name":"Leer Matriz Precios","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[304,272],"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// 1. RECUPERAR DATOS DE FORMA SEGURA (Blindaje contra errores)\nconst webhookData = $('Webhook WhatsApp').first().json.body.entry[0].changes[0].value.messages[0];\n\n// Usamos un \"operador ternario\" (preguntar ? si : no) para evitar el error rojo\n// Si trae texto, lo usamos. Si trae PDF/BotÃ³n, usamos texto vacÃ­o para no romper el flujo.\nconst textoUsuario = webhookData.text ? webhookData.text.body.toLowerCase() : '';\n\nconst orden = $('Verificar Pendiente').first().json;\n\n// 2. RECUPERAR PRECIOS (Esto sÃ­ viene del input directo)\nconst matrizPrecios = $input.all().map(i => i.json);\n\n// 3. LÃ“GICA DE DETECCIÃ“N (EL CEREBRO)\nlet precioPapel = 0;\nlet precioImpresion = 0;\nlet precioExtras = 0;\nlet cantidadJuegos = 1;\nlet detalles = [];\n\n// A) Detectar Cantidad\nconst matchCantidad = textoUsuario.match(/(\\d+)\\s*(juegos|copias|tantos|paquetes|juego|copia)/);\nif (matchCantidad) cantidadJuegos = parseInt(matchCantidad[1]);\n\n// B) Buscar Coincidencias en Matriz\nmatrizPrecios.forEach(prod => {\n    if (prod.palabras_clave) {\n        const keywords = prod.palabras_clave.toString().toLowerCase().split(',').map(k => k.trim());\n        const encontrado = keywords.some(kw => textoUsuario.includes(kw));\n        \n        if (encontrado) {\n            detalles.push(prod.nombre_comercial);\n            if (prod.categoria === 'papel') precioPapel = Math.max(precioPapel, parseFloat(prod.precio));\n            if (prod.categoria === 'impresion') precioImpresion = Math.max(precioImpresion, parseFloat(prod.precio));\n            if (prod.categoria === 'extra') precioExtras += parseFloat(prod.precio);\n        }\n    }\n});\n\n// C) Defaults\nif (precioPapel === 0) { precioPapel = 0.5; detalles.push(\"Papel Bond (Default)\"); }\nif (precioImpresion === 0) { precioImpresion = 1.5; detalles.push(\"B/N (Default)\"); }\n\n// 4. CÃLCULO MATEMÃTICO\nconst paginas = parseInt(orden.paginas || 0);\nconst costoPorJuego = (paginas * (precioPapel + precioImpresion)) + precioExtras;\nconst granTotal = costoPorJuego * cantidadJuegos;\n\nreturn {\n  json: {\n    telefono: orden.telefono,\n    paginas: paginas,\n    resumen: detalles.join(' + '),\n    juegos: cantidadJuegos,\n    unitario: costoPorJuego,\n    total: granTotal\n  }\n};"},"id":"0dc997da-4971-4413-9624-8cbe0a1f4474","name":"Calcular Total","type":"n8n-nodes-base.code","typeVersion":2,"position":[528,272]},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Webhook WhatsApp').item.json.body.entry[0].changes[0].value.messages[0].from }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ¢ Selecciona tu Sucursal\"\n    },\n    \"body\": {\n      \"text\": \"Â¿A cuÃ¡l sucursal pasarÃ¡s a recoger tu pedido?\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sucursal_calzada\",\n            \"title\": \"ðŸ“ Calzada\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sucursal_centro\",\n            \"title\": \"ðŸ“ Centro\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sucursal_16\",\n            \"title\": \"ðŸ“ 16 de Sept.\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{}},"id":"86cf59b0-029c-41de-a394-5ea03959597e","name":"Preguntar Sucursal","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1104,-80],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"authentication":"serviceAccount","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1911314986,"mode":"list","cachedResultName":"OrdenesTemp","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1911314986"},"options":{}},"id":"85cb34fb-0e39-4a83-95a4-efa0a0cd1014","name":"Recuperar PDF ID","type":"n8n-nodes-base.googleSheets","typeVersion":4.1,"position":[1392,112],"credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// 1. RECUPERAR DATOS SEGUROS\nconst webhookData = $('Webhook WhatsApp').first().json.body.entry[0].changes[0].value.messages[0];\nconst telefonoCliente = webhookData.from;\n\n// 2. RECUPERAR ID DEL BOTÃ“N Y LIMPIARLO\nconst seleccionRaw = webhookData.interactive.button_reply.id;\nconst seleccion = String(seleccionRaw).trim();\n\n// ðŸ›‘ FRENO DE EMERGENCIA ðŸ›‘\nif (seleccion === 'confirmar_orden') {\n    return [];\n}\n\n// 3. RECUPERAR PDF ID Y NÃšMERO DE FILA\nconst ordenes = $input.all().map(i => i.json);\nconst orden = ordenes.reverse().find(o => String(o.telefono).replace(/\\D/g, '') === String(telefonoCliente).replace(/\\D/g, ''));\n\n// 4. ASIGNAR SUCURSAL\nlet telefonoSucursal = '';\nlet nombreSucursal = '';\n\n// Â¡OJO! AsegÃºrate de que estos telÃ©fonos sean los correctos\nif (seleccion === 'sucursal_calzada') {\n    telefonoSucursal = '5218421082820'; \n    nombreSucursal = 'Calzada del MarquÃ©s';\n} else if (seleccion === 'sucursal_centro') {\n    telefonoSucursal = '5218421082820'; \n    nombreSucursal = 'Centro';\n} else if (seleccion === 'sucursal_16') {\n    telefonoSucursal = '5218421082820'; \n    nombreSucursal = '16 de Septiembre';\n} else {\n    telefonoSucursal = '5218421082820'; \n    nombreSucursal = 'Sucursal Central';\n}\n\nreturn {\n    json: {\n        telefono_cliente: telefonoCliente,\n        telefono_sucursal: telefonoSucursal,\n        nombre_sucursal: nombreSucursal,\n        pdf_id: orden ? orden.pdf_id : \"NO_ENCONTRADO\",\n        row_number: orden ? orden.row_number : null, // <--- Â¡ESTA ES LA CLAVE NUEVA!\n        detalles: \"Pedido confirmado\"\n    }\n};"},"id":"02bfb6ac-dcfa-41ec-ad1b-417ccc4fa7ff","name":"Preparar EnvÃ­o","type":"n8n-nodes-base.code","typeVersion":2,"position":[1728,128]},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefono_sucursal }}\",\n  \"type\": \"document\",\n  \"document\": {\n    \"id\": \"{{ $json.pdf_id }}\",\n    \"caption\": \"ðŸš¨ *NUEVO PEDIDO AUTORIZADO*\\n\\nCliente: {{ $json.telefono_cliente }}\\nSucursal Destino: *{{ $json.nombre_sucursal }}*\\n\\nâš ï¸ *Imprimir de inmediato.*\"\n  }\n}","options":{}},"id":"1fce9cf0-6a8f-4580-93cb-cf511500a2ea","name":"Enviar PDF a Sucursal","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1968,16],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefono_cliente }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"âœ… *Â¡Todo Listo!*\\n\\nYa enviÃ© tu archivo a la sucursal *{{ $json.nombre_sucursal }}*.\\n\\nLo estarÃ¡n imprimiendo ahora mismo. Puedes pasar a recogerlo en caja mencionando tu nÃºmero.\\n\\n_Â¡Gracias por tu preferencia!_\"\n  }\n}","options":{}},"id":"168d7320-3278-449c-aa45-db425341045e","name":"Avisar al Cliente","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1968,240],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v17.0/1008967208956636/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAAUaPNz8cjcBQawRFHWS938kpxZBMMewlPznXKBhsZC6IZCyBsuGaKGiV5GkxTGSI8aYduCCbf9LPD3se3M536Pi3WbGX8dZBTMiYusBQ6rOLpR3ez6vUOz1bdMhdkD6qrza7Qitqp3VH1we0xZAvjg9TZA9gENCnnZATTeIvHuf4EOz32F14rCdb8AbFh8PqvIdwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefono }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ’° CotizaciÃ³n Lista\"\n    },\n    \"body\": {\n      \"text\": \"âœ… *He entendido tu pedido:*\\n\\nðŸ“„ Documento: {{ $json.paginas }} pÃ¡ginas\\nðŸ› ï¸ Detalles: {{ $json.resumen }}\\nðŸ“¦ Cantidad: *{{ $json.juegos }} juegos*\\n\\nðŸ’µ *TOTAL A PAGAR: ${{ $json.total }}*\\n_(Precio por juego: ${{ $json.unitario }})_\\n\\nÂ¿Todo correcto? Presiona continuar para elegir sucursal.\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"confirmar_orden\",\n            \"title\": \"âœ… SÃ­, Continuar\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"cancelar_orden\",\n            \"title\": \"âŒ Cancelar\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{}},"id":"fb8b0dfb-6a82-4e4d-92cb-7788a7c270db","name":"Enviar CotizaciÃ³n","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[720,336],"credentials":{"httpHeaderAuth":{"id":"HedEaoETmcmIE47J","name":"Header Auth account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"490d0047-2053-48ba-9cf7-963b7cc57a19","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"confirmar_orden","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"91ece125-8153-487e-91f5-4a949e39e4d1","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"sucursal_calzada","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"32d08040-3a2e-4b6f-934c-857cf17b9a5c","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"sucursal_centro","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"ca4ac786-2b59-4c51-97f4-71e80d1f8f1c","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"sucursal_16","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"0b73690b-f4c8-4a67-83b3-43c39e53da37","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}","rightValue":"cancelar_orden","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[704,32],"id":"34a3448c-763a-4a91-839a-9ac88ddbd3ee","name":"Switch"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","rightValue":"=document","operator":{"type":"string","operation":"equals"},"id":"96f789f1-41a1-4757-990e-01621279ac80"}],"combinator":"and"},"renameOutput":true,"outputKey":"0"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"90dcfaaa-7bae-4599-88ec-dcc54ef7fca7","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"0"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"e0249303-5f1d-4000-9f26-01c2ed306d39","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","rightValue":"text","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"1"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"b45dedb0-21d1-4525-a0b0-32eb884acc82","leftValue":"={{ $json.body.entry[0].changes[0].value.messages[0].type }}","rightValue":"interactive","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"2"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-880,144],"id":"d09e02d5-c31d-464f-bbcc-fc60469e7c90","name":"tipo de mensaje"},{"parameters":{"authentication":"serviceAccount","operation":"delete","documentId":{"__rl":true,"value":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit?usp=sharing","mode":"url"},"sheetName":{"__rl":true,"value":1911314986,"mode":"list","cachedResultName":"OrdenesTemp","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TeJzUtnwLaPSrZ8uhcF5O4xEwilx65eh3EWBUdzHK6Y/edit#gid=1911314986"},"startIndex":"={{ $('Preparar EnvÃ­o').first().json.row_number }}"},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2240,32],"id":"a6e951b1-cf60-472c-8812-8923af749a3f","name":"Delete rows or columns from sheet","credentials":{"googleApi":{"id":"sXDowqbmhngQSb6Z","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// ==========================================\n// ðŸš€ MOTOR DE BÃšSQUEDA INTELIGENTE V3.0\n// ==========================================\n\n// ==========================================\n// ðŸ“š CONFIGURACIÃ“N Y DICCIONARIOS\n// ==========================================\n\nconst CONFIG = {\n    umbralMinimo: 0.35,\n    maxResultados: 5,\n    pesoAncla: 0.4,\n    pesoCobertura: 0.35,\n    pesoOrden: 0.15,\n    pesoExactitud: 0.10\n};\n\nconst DICCIONARIO = {\n    // Servicios\n    \"luz\": [\"cfe\", \"comision\", \"electricidad\", \"recibo\", \"corriente\"],\n    \"agua\": [\"aguakan\", \"capa\", \"sas\", \"potable\", \"hidrico\"],\n    \"internet\": [\"telmex\", \"modem\", \"wifi\", \"megacable\", \"red\", \"infinitum\"],\n    \n    // Productos papelerÃ­a\n    \"lapiz\": [\"lÃ¡piz\", \"mirado\", \"grafito\", \"bicolor\", \"dixon\", \"numero\"],\n    \"pluma\": [\"boligrafo\", \"lapicero\", \"tinta\", \"punto\", \"bic\", \"kilometrico\"],\n    \"goma\": [\"borrador\", \"miga\", \"factis\", \"migajon\", \"pelikan\"],\n    \"diurex\": [\"cinta\", \"adhesiva\", \"scotch\", \"janel\", \"canela\", \"transparente\"],\n    \"hojas\": [\"papel\", \"bond\", \"carta\", \"oficio\", \"resma\", \"opalina\", \"blancas\"],\n    \"libreta\": [\"cuaderno\", \"profesional\", \"forma\", \"francesa\", \"italiana\", \"cosida\", \"spiral\", \"scribe\", \"rayado\"],\n    \"colores\": [\"caja\", \"pinturas\", \"madera\", \"maped\", \"norma\", \"vividel\", \"blanca\", \"nieves\", \"crayola\"],\n    \"marcador\": [\"plumon\", \"sharpie\", \"texto\", \"agua\", \"aceite\", \"permanente\", \"pilot\"],\n    \"regla\": [\"30cm\", \"metal\", \"plastico\", \"graduada\"],\n    \"tijeras\": [\"escolares\", \"punta\", \"redonda\", \"metalicas\"],\n    \"resistol\": [\"pegamento\", \"blanco\", \"liquido\", \"barra\", \"kola\", \"loka\"],\n    \"corrector\": [\"liquid\", \"paper\", \"cinta\", \"lapiz\"],\n    \n    // Atributos\n    \"numero\": [\"no\", \"num\", \"#\", \"calibre\"],\n    \"caja\": [\"paquete\", \"juego\", \"estuche\", \"set\"],\n    \"pieza\": [\"suelta\", \"unidad\", \"pz\", \"individual\"],\n    \"economico\": [\"barato\", \"sencillo\", \"escolar\", \"chafa\"]\n};\n\n// PALABRAS DE RELLENO EXPANDIDAS (lenguaje coloquial mexicano)\nconst STOPWORDS = new Set([\n    // Saludos\n    \"hola\", \"buenos\", \"dias\", \"tardes\", \"noches\", \"buenas\", \"que\", \"onda\",\n    \n    // Verbos de solicitud\n    \"venden\", \"venen\", \"vendes\", \"vendran\", \"vende\",\n    \"tendras\", \"tendra\", \"tendran\",\n    \"tienes\", \"tiene\", \"tienen\", \"tuviera\",\n    \"quisiera\", \"quiero\", \"queria\", \"querria\",\n    \"necesito\", \"necesitas\", \"necesita\", \"ocupo\", \"ocupas\", \"ocupa\", // â† COLOQUIAL\n    \"busco\", \"buscas\", \"busca\",\n    \"puedo\", \"puede\", \"pueden\", \"podria\", \"podrias\",\n    \"haber\", \"hay\", \"habra\",\n    \"dame\", \"deme\", \"danos\", \"das\", \"da\", \"den\", // â† COLOQUIAL\n    \"pagar\", \"cobrar\", \"costar\",\n    \n    // Preguntas\n    \"precio\", \"costo\", \"cuanto\", \"cuantos\", \"cuanta\", \"sale\", \"salen\",\n    \"cotizame\", \"cotiza\", \"cotizacion\",\n    \"disponible\", \"existencia\", \"stock\",\n    \n    // ArtÃ­culos y conectores\n    \"el\", \"la\", \"los\", \"las\", \"un\", \"una\", \"unos\", \"unas\",\n    \"de\", \"del\", \"al\", \"para\", \"por\", \"con\", \"sin\", \"y\", \"o\", \"que\", \"si\",\n    \"me\", \"te\", \"le\", \"mi\", \"mis\", \"sus\", \"su\", \"tu\", \"tus\",\n    \n    // CortesÃ­a\n    \"favor\", \"gracias\", \"please\", \"porfavor\", \"porfa\",\n    \"disculpa\", \"disculpe\", \"oye\", \"oiga\",\n    \n    // Otros\n    \"algun\", \"alguna\", \"algunos\", \"tipo\", \"tipos\", \"marca\", \"marcas\"\n]);\n\n// ==========================================\n// ðŸ”§ UTILIDADES CORE\n// ==========================================\n\nclass TextProcessor {\n    static normalizar(texto) {\n        if (!texto) return '';\n        return texto.toString().toLowerCase()\n            .normalize(\"NFD\")\n            .replace(/[\\u0300-\\u036f]/g, \"\")\n            .replace(/[^a-z0-9 ]/g, \" \")\n            .replace(/\\s+/g, \" \")\n            .trim();\n    }\n    \n    static tokenizar(texto) {\n        return this.normalizar(texto)\n            .split(\" \")\n            .filter(p => p.length > 0 && !STOPWORDS.has(p));\n    }\n    \n    static expandirSinonimos(palabra) {\n        const variaciones = new Set([palabra]);\n        \n        for (const [concepto, sinonimos] of Object.entries(DICCIONARIO)) {\n            if (concepto === palabra || sinonimos.includes(palabra)) {\n                variaciones.add(concepto);\n                sinonimos.forEach(s => variaciones.add(s));\n            }\n        }\n        \n        return Array.from(variaciones);\n    }\n    \n    // Distancia de Levenshtein optimizada\n    static similitud(s1, s2) {\n        if (s1 === s2) return 1.0;\n        if (s1.length === 0 || s2.length === 0) return 0.0;\n        \n        let longer = s1.length > s2.length ? s1 : s2;\n        let shorter = s1.length > s2.length ? s2 : s1;\n        \n        const longerLen = longer.length;\n        const costs = Array(shorter.length + 1).fill(0).map((_, i) => i);\n        \n        for (let i = 1; i <= longerLen; i++) {\n            let prev = i;\n            for (let j = 1; j <= shorter.length; j++) {\n                let current;\n                if (longer[i-1] === shorter[j-1]) {\n                    current = costs[j-1];\n                } else {\n                    current = Math.min(costs[j-1], prev, costs[j]) + 1;\n                }\n                costs[j-1] = prev;\n                prev = current;\n            }\n            costs[shorter.length] = prev;\n        }\n        \n        return 1 - (costs[shorter.length] / longerLen);\n    }\n}\n\n// ==========================================\n// ðŸ—‚ï¸ ÃNDICE DE PRODUCTOS (CACHÃ‰)\n// ==========================================\n\nclass ProductIndex {\n    constructor() {\n        this.productos = [];\n        this.indiceInvertido = new Map(); // palabra -> [ids productos]\n        this.cache = new Map();\n    }\n    \n    indexar(productos) {\n        this.productos = productos.map((item, idx) => {\n            const datos = item.json;\n            const keys = Object.keys(datos);\n            \n            const keyNombre = keys.find(k => /nombre|producto|descripcion/i.test(k));\n            const keyPrecio = keys.find(k => /precio|costo|amount/i.test(k));\n            \n            const nombreOriginal = keyNombre ? datos[keyNombre] : '';\n            const precio = keyPrecio ? parseFloat(datos[keyPrecio]) : 0;\n            \n            const tokens = TextProcessor.tokenizar(nombreOriginal);\n            \n            // Construir Ã­ndice invertido\n            tokens.forEach(token => {\n                if (!this.indiceInvertido.has(token)) {\n                    this.indiceInvertido.set(token, []);\n                }\n                this.indiceInvertido.get(token).push(idx);\n            });\n            \n            return {\n                id: idx,\n                nombreOriginal: nombreOriginal.toString().replace(/\"/g, \"\").replace(/\\n/g, \" \"),\n                tokens,\n                precio: isNaN(precio) ? 0 : precio,\n                datosOriginales: datos\n            };\n        });\n    }\n    \n    // Obtener candidatos usando Ã­ndice invertido (mucho mÃ¡s rÃ¡pido)\n    obtenerCandidatos(tokensQuery) {\n        const candidatosSet = new Set();\n        \n        tokensQuery.forEach(token => {\n            const variaciones = TextProcessor.expandirSinonimos(token);\n            \n            variaciones.forEach(variacion => {\n                // BÃºsqueda exacta en Ã­ndice\n                if (this.indiceInvertido.has(variacion)) {\n                    this.indiceInvertido.get(variacion).forEach(id => candidatosSet.add(id));\n                }\n                \n                // BÃºsqueda fuzzy en Ã­ndice (solo para palabras largas)\n                if (variacion.length >= 4) {\n                    for (const [palabraIndice, ids] of this.indiceInvertido.entries()) {\n                        if (TextProcessor.similitud(variacion, palabraIndice) > 0.8) {\n                            ids.forEach(id => candidatosSet.add(id));\n                        }\n                    }\n                }\n            });\n        });\n        \n        return Array.from(candidatosSet).map(id => this.productos[id]);\n    }\n}\n\n// ==========================================\n// ðŸŽ¯ MOTOR DE SCORING\n// ==========================================\n\nclass ScoringEngine {\n    static calcular(producto, tokensQuery, palabraAncla) {\n        let scores = {\n            ancla: 0,\n            cobertura: 0,\n            orden: 0,\n            exactitud: 0\n        };\n        \n        const tokensProducto = producto.tokens;\n        let conceptosEncontrados = 0;\n        let scoreAcumulado = 0;\n        \n        tokensQuery.forEach((tokenQuery, indexQuery) => {\n            const variaciones = TextProcessor.expandirSinonimos(tokenQuery);\n            let mejorMatch = 0;\n            let posicionEncontrada = -1;\n            \n            tokensProducto.forEach((tokenProd, indexProd) => {\n                variaciones.forEach(variacion => {\n                    let score;\n                    \n                    // NÃºmeros y palabras cortas: match exacto\n                    if (!isNaN(variacion) || variacion.length <= 2) {\n                        score = tokenProd === variacion ? 1.0 : 0;\n                    } else {\n                        score = TextProcessor.similitud(variacion, tokenProd);\n                    }\n                    \n                    if (score > mejorMatch) {\n                        mejorMatch = score;\n                        posicionEncontrada = indexProd;\n                    }\n                });\n            });\n            \n            if (mejorMatch > 0.75) {\n                conceptosEncontrados++;\n                scoreAcumulado += mejorMatch;\n                \n                // Score del ancla\n                if (indexQuery === 0 && palabraAncla) {\n                    scores.ancla = mejorMatch;\n                }\n                \n                // Score de orden (bonus si aparece en orden similar)\n                if (posicionEncontrada >= 0) {\n                    const diferenciaOrden = Math.abs(indexQuery - posicionEncontrada);\n                    scores.orden += (1 / (1 + diferenciaOrden)) * mejorMatch;\n                }\n            }\n        });\n        \n        // Cobertura: quÃ© % de conceptos del usuario se encontraron\n        scores.cobertura = tokensQuery.length > 0 \n            ? conceptosEncontrados / tokensQuery.length \n            : 0;\n        \n        // Exactitud: quÃ© tan bien matchearon en promedio\n        scores.exactitud = tokensQuery.length > 0 \n            ? scoreAcumulado / tokensQuery.length \n            : 0;\n        \n        // Normalizar orden\n        scores.orden = tokensQuery.length > 0 \n            ? scores.orden / tokensQuery.length \n            : 0;\n        \n        // Score final ponderado\n        const scoreFinal = \n            (scores.ancla * CONFIG.pesoAncla) +\n            (scores.cobertura * CONFIG.pesoCobertura) +\n            (scores.orden * CONFIG.pesoOrden) +\n            (scores.exactitud * CONFIG.pesoExactitud);\n        \n        // Bonus por cobertura completa\n        const bonus = scores.cobertura === 1.0 ? 0.15 : 0;\n        \n        return {\n            total: Math.min(scoreFinal + bonus, 1.0),\n            desglose: scores\n        };\n    }\n}\n\n// ==========================================\n// ðŸ” MOTOR PRINCIPAL\n// ==========================================\n\nclass SearchEngine {\n    constructor() {\n        this.indice = new ProductIndex();\n    }\n    \n    indexarProductos(productos) {\n        this.indice.indexar(productos);\n    }\n    \n    buscar(query) {\n        const tokensQuery = TextProcessor.tokenizar(query);\n        \n        if (tokensQuery.length === 0) {\n            return {\n                encontrado: false,\n                resultados: [],\n                debug: {\n                    tokensQuery: [],\n                    mensaje: \"No se detectaron palabras vÃ¡lidas\"\n                }\n            };\n        }\n        \n        const palabraAncla = tokensQuery[0];\n        \n        // Obtener candidatos usando Ã­ndice invertido (RÃPIDO)\n        const candidatos = this.indice.obtenerCandidatos(tokensQuery);\n        \n        // Calcular scores solo para candidatos\n        const resultados = candidatos.map(producto => {\n            const scoring = ScoringEngine.calcular(producto, tokensQuery, palabraAncla);\n            \n            return {\n                ...producto,\n                score: scoring.total,\n                scoreDesglose: scoring.desglose\n            };\n        });\n        \n        // Filtrar y ordenar\n        const filtrados = resultados\n            .filter(r => r.score >= CONFIG.umbralMinimo)\n            .sort((a, b) => b.score - a.score)\n            .slice(0, CONFIG.maxResultados);\n        \n        return {\n            encontrado: filtrados.length > 0,\n            resultados: filtrados,\n            debug: {\n                tokensQuery,\n                palabraAncla,\n                candidatosEvaluados: candidatos.length,\n                resultadosFiltrados: filtrados.length\n            }\n        };\n    }\n}\n\n// ==========================================\n// ðŸš€ EJECUCIÃ“N PRINCIPAL\n// ==========================================\n\n// 1. Obtener mensaje de WhatsApp\nlet telefono = \"\", mensajeOriginal = \"\";\ntry {\n    const data = $('Webhook WhatsApp').first().json.body.entry[0].changes[0].value.messages[0];\n    mensajeOriginal = data.text.body;\n    telefono = data.from;\n} catch (e) {\n    mensajeOriginal = \"\";\n    telefono = \"520000000000\";\n}\n\n// 2. Inicializar motor\nconst motor = new SearchEngine();\nmotor.indexarProductos($input.all());\n\n// 3. Buscar\nconst resultado = motor.buscar(mensajeOriginal);\n\n// 4. Generar respuesta WhatsApp\nlet mensajeTexto = \"\";\n\nif (!resultado.encontrado) {\n    mensajeTexto = `âŒ *No encontrÃ© resultados exactos.*\\n\\n` +\n                   `Intenta con palabras simples como:\\n` +\n                   `_\"LÃ¡piz\"_, _\"Cuaderno\"_, _\"Colores\"_\\n\\n` +\n                   `_(BusquÃ©: ${resultado.debug.tokensQuery.join(\" + \")})_`;\n} else {\n    mensajeTexto = `âœ… *EncontrÃ© ${resultado.resultados.length} opciones:*\\n\\n`;\n    \n    resultado.resultados.forEach((prod, idx) => {\n        mensajeTexto += `${idx + 1}. *${prod.nombreOriginal}*\\n`;\n        mensajeTexto += `   ðŸ’° $${prod.precio.toFixed(2)}\\n`;\n        mensajeTexto += `   ðŸ“Š Relevancia: ${(prod.score * 100).toFixed(0)}%\\n\\n`;\n    });\n    \n    mensajeTexto += \"ðŸ‘‡ *Escribe el nombre exacto del producto o envÃ­a foto para ordenar.*\";\n}\n\nconst bodyObject = {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": telefono,\n    \"type\": \"text\",\n    \"text\": { \"body\": mensajeTexto }\n};\n\n// 5. Retornar resultado\nreturn [{\n    json: {\n        encontrado: resultado.encontrado,\n        json_para_whatsapp: JSON.stringify(bodyObject),\n        debug_query: mensajeOriginal,\n        debug_tokens: resultado.debug.tokensQuery.join(\" + \"),\n        debug_candidatos: resultado.debug.candidatosEvaluados,\n        debug_top_match: resultado.encontrado ? resultado.resultados[0].nombreOriginal : \"Nada\",\n        debug_top_score: resultado.encontrado ? resultado.resultados[0].score.toFixed(3) : \"0\"\n    }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[208,912],"id":"6c1dfb41-4d6d-4d16-b7bb-d801b87fefd9","name":"Code in JavaScript1"}],"connections":{"Webhook WhatsApp":{"main":[[{"node":"tipo de mensaje","type":"main","index":0}]]},"Â¿Es Saludo o BÃºsqueda?":{"main":[[{"node":"Enviar MenÃº (HTTP)","type":"main","index":0}],[{"node":"Buscar Ordenes Pendientes","type":"main","index":0}]]},"Leer Todos los Productos":{"main":[[{"node":"Code in JavaScript1","type":"main","index":0}]]},"Enviar MenÃº (HTTP)":{"main":[[]]},"Â¿Es un Documento?":{"main":[[{"node":"Obtener URL de Descarga","type":"main","index":0}],[]]},"Obtener URL de Descarga":{"main":[[{"node":"Descargar PDF","type":"main","index":0}]]},"Descargar PDF":{"main":[[{"node":"Enviar a Python","type":"main","index":0}]]},"Enviar a Python":{"main":[[{"node":"Guardar en Memoria","type":"main","index":0}]]},"Guardar en Memoria":{"main":[[{"node":"Preguntar Detalles","type":"main","index":0}]]},"Buscar Ordenes Pendientes":{"main":[[{"node":"Verificar Pendiente","type":"main","index":0}]]},"Verificar Pendiente":{"main":[[{"node":"Â¿Es CotizaciÃ³n?","type":"main","index":0}]]},"Â¿Es CotizaciÃ³n?":{"main":[[{"node":"Leer Matriz Precios","type":"main","index":0}],[{"node":"Leer Todos los Productos","type":"main","index":0}]]},"Leer Matriz Precios":{"main":[[{"node":"Calcular Total","type":"main","index":0}]]},"Calcular Total":{"main":[[{"node":"Enviar CotizaciÃ³n","type":"main","index":0}]]},"Recuperar PDF ID":{"main":[[{"node":"Preparar EnvÃ­o","type":"main","index":0}]]},"Preparar EnvÃ­o":{"main":[[{"node":"Enviar PDF a Sucursal","type":"main","index":0},{"node":"Avisar al Cliente","type":"main","index":0}]]},"Enviar CotizaciÃ³n":{"main":[[]]},"Preguntar Sucursal":{"main":[[{"node":"Recuperar PDF ID","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Preguntar Sucursal","type":"main","index":0}],[{"node":"Recuperar PDF ID","type":"main","index":0}],[{"node":"Recuperar PDF ID","type":"main","index":0}],[{"node":"Recuperar PDF ID","type":"main","index":0}],[]]},"tipo de mensaje":{"main":[[{"node":"Â¿Es un Documento?","type":"main","index":0}],[{"node":"Â¿Es un Documento?","type":"main","index":0}],[{"node":"Â¿Es Saludo o BÃºsqueda?","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"Enviar PDF a Sucursal":{"main":[[{"node":"Delete rows or columns from sheet","type":"main","index":0}]]},"Avisar al Cliente":{"main":[[]]},"Code in JavaScript1":{"main":[[{"node":"Enviar No Encontrado","type":"main","index":0}]]}},"authors":"Dilan Lucio","name":"Version a801897f","description":"","autosaved":false},"tags":[]}],"nextCursor":null}